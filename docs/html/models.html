
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>Models &#8212; ml_clim  documentation</title>
    <link rel="stylesheet" href="_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/language_data.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="prev" title="Dataloader" href="dataloader.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="dataloader.html" title="Dataloader"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">ml_clim  documentation</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="models">
<h1>Models<a class="headerlink" href="#models" title="Permalink to this headline">¶</a></h1>
<p>All models extend the following base model:</p>
<dl class="class">
<dt id="src.models.base.ModelBase">
<em class="property">class </em><code class="sig-prename descclassname">src.models.base.</code><code class="sig-name descname">ModelBase</code><span class="sig-paren">(</span><em class="sig-param">data_folder: pathlib.Path = PosixPath('data')</em>, <em class="sig-param">batch_size: int = 1</em>, <em class="sig-param">experiment: str = 'one_month_forecast'</em>, <em class="sig-param">pred_months: Optional[List[int]] = None</em>, <em class="sig-param">include_pred_month: bool = True</em>, <em class="sig-param">include_latlons: bool = False</em>, <em class="sig-param">include_monthly_aggs: bool = True</em>, <em class="sig-param">include_yearly_aggs: bool = True</em>, <em class="sig-param">surrounding_pixels: Optional[int] = None</em>, <em class="sig-param">ignore_vars: Optional[List[str]] = None</em>, <em class="sig-param">static: Optional[str] = 'embedding'</em>, <em class="sig-param">predict_delta: bool = False</em>, <em class="sig-param">spatial_mask: Union[xarray.core.dataarray.DataArray</em>, <em class="sig-param">pathlib.Path] = None</em>, <em class="sig-param">include_prev_y: bool = False</em>, <em class="sig-param">normalize_y: bool = False</em><span class="sig-paren">)</span><a class="headerlink" href="#src.models.base.ModelBase" title="Permalink to this definition">¶</a></dt>
<dd><p>Base for all machine learning models.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>data</strong> – The location of the data folder. Default = <code class="docutils literal notranslate"><span class="pre">pathlib.Path(&quot;data&quot;)</span></code></p></li>
<li><p><strong>batch_size</strong> – The number of files to load at once. These will be chunked and
shuffled, so a higher value will lead to better shuffling
(but will require more memory). Default = <code class="docutils literal notranslate"><span class="pre">1</span></code>.</p></li>
<li><p><strong>experiment</strong> – The name of the experiment to run. Specifically, the name of the engineer
used to generate the data. Default = <code class="docutils literal notranslate"><span class="pre">&quot;one_month_forecast&quot;</span></code>
(train on only historical data and predict one month ahead)</p></li>
<li><p><strong>pred_months</strong> – The months the model should predict. If None, all months are predicted.
Default = <code class="docutils literal notranslate"><span class="pre">None</span></code>.</p></li>
<li><p><strong>include_pred_month</strong> – Whether to include the prediction month to the model’s training data.
Default = <code class="docutils literal notranslate"><span class="pre">True</span></code>.</p></li>
<li><p><strong>include_latlons</strong> – Whether to include prediction pixel latitudes and longitudes in the model’s
training data. Default = <code class="docutils literal notranslate"><span class="pre">True</span></code>.</p></li>
<li><p><strong>include_monthly_aggs</strong> – Whether to include monthly aggregations. Default = <code class="docutils literal notranslate"><span class="pre">True</span></code>.</p></li>
<li><p><strong>include_yearly_aggs</strong> – Whether to include yearly aggregations. Default = <code class="docutils literal notranslate"><span class="pre">True</span></code>.</p></li>
<li><p><strong>surrounding_pixels</strong> – How many surrounding pixels to add to the input data. e.g. if the input
is 1, then in addition to the pixels on the prediction point, the neighbouring (spatial) pixels will
be included too, up to a distance of one pixel away. Default = <code class="docutils literal notranslate"><span class="pre">None</span></code>.</p></li>
<li><p><strong>ignore_vars</strong> – A list of variables to ignore. If None, all variables in the data_path will be included.
Default = <code class="docutils literal notranslate"><span class="pre">None</span></code>.</p></li>
<li><p><strong>static</strong> – Whether to include static data. Default = <code class="docutils literal notranslate"><span class="pre">True</span></code>.</p></li>
<li><p><strong>predict_delta</strong> – Whether to model the change in target variable rather than the
raw values. Default = <code class="docutils literal notranslate"><span class="pre">False</span></code>.</p></li>
<li><p><strong>spatial_mask</strong> – If an <code class="docutils literal notranslate"><span class="pre">xr.DataArray`</span> <span class="pre">is</span> <span class="pre">passed,</span> <span class="pre">it</span> <span class="pre">will</span> <span class="pre">be</span> <span class="pre">used</span> <span class="pre">to</span> <span class="pre">mask</span> <span class="pre">the</span> <span class="pre">training</span> <span class="pre">/</span> <span class="pre">test</span> <span class="pre">data.</span>
<span class="pre">Default</span> <span class="pre">=</span> <span class="pre">``None</span></code>.</p></li>
<li><p><strong>include_pred_y</strong> – Whether to include the y value from one year ago, the same month. This is useful if
you are predicting a seasonal value. Default = <code class="docutils literal notranslate"><span class="pre">False</span></code>.</p></li>
<li><p><strong>normalize_y</strong> – Whether to normalize the y value being predicted. Default = <code class="docutils literal notranslate"><span class="pre">False</span></code>. The predictions
saved in <code class="docutils literal notranslate"><span class="pre">evaluate</span></code> will be denormalized.</p></li>
</ul>
</dd>
</dl>
<dl class="method">
<dt id="src.models.base.ModelBase.evaluate">
<code class="sig-name descname">evaluate</code><span class="sig-paren">(</span><em class="sig-param">save_results: bool = True</em>, <em class="sig-param">save_preds: bool = False</em><span class="sig-paren">)</span> &#x2192; None<a class="headerlink" href="#src.models.base.ModelBase.evaluate" title="Permalink to this definition">¶</a></dt>
<dd><p>Evaluate the trained model on the test data</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>save_results</strong> – Whether to save the results of the evaluation. If true, they are
saved in <code class="docutils literal notranslate"><span class="pre">self.model_dir</span> <span class="pre">/</span> <span class="pre">results.json</span></code>. Default = <code class="docutils literal notranslate"><span class="pre">True</span></code>.</p></li>
<li><p><strong>save_preds</strong> – Whether to save the model predictions. If true, they are saved in
<code class="docutils literal notranslate"><span class="pre">self.model_dir</span> <span class="pre">/</span> <span class="pre">{year}_{month}.nc</span></code>. Default = <code class="docutils literal notranslate"><span class="pre">False</span></code>.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="method">
<dt id="src.models.base.ModelBase.explain">
<code class="sig-name descname">explain</code><span class="sig-paren">(</span><em class="sig-param">x: Any</em><span class="sig-paren">)</span> &#x2192; numpy.ndarray<a class="headerlink" href="#src.models.base.ModelBase.explain" title="Permalink to this definition">¶</a></dt>
<dd><p>Explain the predictions of the trained model on the input data x</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><p><strong>x</strong> – Any input array / tensor</p>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p>A shap value for each of the input values. The sum of the shap
values is equal to the prediction of the model for x</p>
</dd>
</dl>
</dd></dl>

<dl class="method">
<dt id="src.models.base.ModelBase.get_dataloader">
<code class="sig-name descname">get_dataloader</code><span class="sig-paren">(</span><em class="sig-param">mode: str</em>, <em class="sig-param">to_tensor: bool = False</em>, <em class="sig-param">shuffle_data: bool = False</em>, <em class="sig-param">**kwargs</em><span class="sig-paren">)</span> &#x2192; src.models.data.DataLoader<a class="headerlink" href="#src.models.base.ModelBase.get_dataloader" title="Permalink to this definition">¶</a></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">Returns</dt>
<dd class="field-odd"><p>The correct dataloader for this model</p>
</dd>
</dl>
</dd></dl>

</dd></dl>

<div class="section" id="loading-models">
<h2>Loading models<a class="headerlink" href="#loading-models" title="Permalink to this headline">¶</a></h2>
<p>Models have a <code class="docutils literal notranslate"><span class="pre">save_model</span></code> function, which saves the model to a pickle object. These
can then be loaded using the <code class="docutils literal notranslate"><span class="pre">load_model</span></code> function:</p>
<dl class="function">
<dt id="src.models.load_model">
<code class="sig-prename descclassname">src.models.</code><code class="sig-name descname">load_model</code><span class="sig-paren">(</span><em class="sig-param">model_path: pathlib.Path</em>, <em class="sig-param">data_path: Optional[pathlib.Path] = None</em>, <em class="sig-param">model_type: Optional[str] = None</em>, <em class="sig-param">device: Optional[str] = 'cpu'</em><span class="sig-paren">)</span> &#x2192; Union[src.models.neural_networks.rnn.RecurrentNetwork, src.models.neural_networks.linear_network.LinearNetwork, src.models.regression.LinearRegression, src.models.neural_networks.ealstm.EARecurrentNetwork, src.models.gbdt.GBDT]<a class="headerlink" href="#src.models.load_model" title="Permalink to this definition">¶</a></dt>
<dd><p>This function loads models from the output <cite>.pkl</cite> files generated when
calling model.save_model()</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>model_path</strong> – The path to the model</p></li>
<li><p><strong>data_path</strong> – The path to the data folder. If None, the function infers this from the
model_path (assuming it was saved as part of the pipeline). Default = <code class="docutils literal notranslate"><span class="pre">None</span></code>.</p></li>
<li><p><strong>model_type</strong> – The type of model to load. If None, the function infers this from the
model_path (assuming it was saved as part of the pipeline). Default = <code class="docutils literal notranslate"><span class="pre">None</span></code>.</p></li>
<li><p><strong>device</strong> – The device to load the model onto</p></li>
</ul>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p>A model object loaded from the model_path</p>
</dd>
</dl>
</dd></dl>

<p>The following models have been implemented:</p>
</div>
<div class="section" id="persistence">
<h2>Persistence<a class="headerlink" href="#persistence" title="Permalink to this headline">¶</a></h2>
<dl class="class">
<dt id="src.models.parsimonious.Persistence">
<em class="property">class </em><code class="sig-prename descclassname">src.models.parsimonious.</code><code class="sig-name descname">Persistence</code><span class="sig-paren">(</span><em class="sig-param">data_folder: pathlib.Path = PosixPath('data')</em><span class="sig-paren">)</span><a class="headerlink" href="#src.models.parsimonious.Persistence" title="Permalink to this definition">¶</a></dt>
<dd><p>A parsimonious persistence model.
This “model” predicts the previous time-value of data. For example, its prediction
for VHI in March 2018 will be VHI for February 2018 (assuming monthly time-granularity).</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><p><strong>data_folder</strong> – Location of the data folder. Default = <code class="docutils literal notranslate"><span class="pre">pathlib.Path(&quot;data&quot;)</span></code>.</p>
</dd>
</dl>
<dl class="method">
<dt id="src.models.parsimonious.Persistence.train">
<code class="sig-name descname">train</code><span class="sig-paren">(</span><span class="sig-paren">)</span> &#x2192; None<a class="headerlink" href="#src.models.parsimonious.Persistence.train" title="Permalink to this definition">¶</a></dt>
<dd><p>This “model” does not need to be trained!</p>
</dd></dl>

</dd></dl>

</div>
<div class="section" id="linear-regression">
<h2>Linear Regression<a class="headerlink" href="#linear-regression" title="Permalink to this headline">¶</a></h2>
<dl class="class">
<dt id="src.models.regression.LinearRegression">
<em class="property">class </em><code class="sig-prename descclassname">src.models.regression.</code><code class="sig-name descname">LinearRegression</code><span class="sig-paren">(</span><em class="sig-param">data_folder: pathlib.Path = PosixPath('data')</em>, <em class="sig-param">experiment: str = 'one_month_forecast'</em>, <em class="sig-param">batch_size: int = 1</em>, <em class="sig-param">pred_months: Optional[List[int]] = None</em>, <em class="sig-param">include_pred_month: bool = True</em>, <em class="sig-param">include_latlons: bool = False</em>, <em class="sig-param">include_monthly_aggs: bool = True</em>, <em class="sig-param">include_yearly_aggs: bool = True</em>, <em class="sig-param">surrounding_pixels: Optional[int] = None</em>, <em class="sig-param">ignore_vars: Optional[List[str]] = None</em>, <em class="sig-param">static: Optional[str] = 'features'</em>, <em class="sig-param">predict_delta: bool = False</em>, <em class="sig-param">spatial_mask: Union[xarray.core.dataarray.DataArray</em>, <em class="sig-param">pathlib.Path] = None</em>, <em class="sig-param">include_prev_y: bool = True</em>, <em class="sig-param">normalize_y: bool = True</em><span class="sig-paren">)</span><a class="headerlink" href="#src.models.regression.LinearRegression" title="Permalink to this definition">¶</a></dt>
<dd><p>A linear regression model, implemented by
<a class="reference external" href="https://scikit-learn.org/stable/modules/generated/sklearn.linear_model.SGDRegressor.html#sklearn.linear_model.SGDRegressor">scikit-learn</a>.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>data_folder</strong> – Location of the data folder. Default = <code class="docutils literal notranslate"><span class="pre">pathlib.Path(&quot;data&quot;)</span></code>.</p></li>
<li><p><strong>experiment</strong> – The name of the experiment to run. Specifically, the name of the engineer
used to generate the data. Default = <code class="docutils literal notranslate"><span class="pre">&quot;one_month_forecast&quot;</span></code>
(train on only historical data and predict one month ahead)</p></li>
<li><p><strong>batch_size</strong> – The number of files to load at once. These will be chunked and
shuffled, so a higher value will lead to better shuffling
(but will require more memory). Default = <code class="docutils literal notranslate"><span class="pre">1</span></code>.</p></li>
<li><p><strong>pred_months</strong> – The months the model should predict. If None, all months are predicted.
Default = <code class="docutils literal notranslate"><span class="pre">None</span></code>.</p></li>
<li><p><strong>include_pred_month</strong> – Whether to include the prediction month to the model’s training data.
Default = <code class="docutils literal notranslate"><span class="pre">True</span></code>.</p></li>
<li><p><strong>include_latlons</strong> – Whether to include prediction pixel latitudes and longitudes in the model’s
training data. Default = <code class="docutils literal notranslate"><span class="pre">True</span></code>.</p></li>
<li><p><strong>include_monthly_aggs</strong> – Whether to include monthly aggregations. Default = <code class="docutils literal notranslate"><span class="pre">True</span></code>.</p></li>
<li><p><strong>include_yearly_aggs</strong> – Whether to include yearly aggregations. Default = <code class="docutils literal notranslate"><span class="pre">True</span></code>.</p></li>
<li><p><strong>surrounding_pixels</strong> – How many surrounding pixels to add to the input data. e.g. if the input
is 1, then in addition to the pixels on the prediction point, the neighbouring (spatial) pixels will
be included too, up to a distance of one pixel away. Default = <code class="docutils literal notranslate"><span class="pre">None</span></code>.</p></li>
<li><p><strong>ignore_vars</strong> – A list of variables to ignore. If None, all variables in the data_path will be included.
Default = <code class="docutils literal notranslate"><span class="pre">None</span></code>.</p></li>
<li><p><strong>static</strong> – Whether to include static data. Default = <code class="docutils literal notranslate"><span class="pre">True</span></code>.</p></li>
<li><p><strong>predict_delta</strong> – Whether to model the change in target variable rather than the
raw values. Default = <code class="docutils literal notranslate"><span class="pre">False</span></code>.</p></li>
<li><p><strong>spatial_mask</strong> – If an <code class="docutils literal notranslate"><span class="pre">xr.DataArray</span></code> is passed, it will be used to mask the training / test data.
Default = <code class="docutils literal notranslate"><span class="pre">None</span></code>.</p></li>
<li><p><strong>include_pred_y</strong> – Whether to include the y value from one year ago, the same month. This is useful if
you are predicting a seasonal value. Default = <code class="docutils literal notranslate"><span class="pre">False</span></code>.</p></li>
<li><p><strong>normalize_y</strong> – Whether to normalize the y value being predicted. Default = <code class="docutils literal notranslate"><span class="pre">False</span></code>. The predictions
saved in <code class="docutils literal notranslate"><span class="pre">evaluate</span></code> will be denormalized.</p></li>
</ul>
</dd>
</dl>
<dl class="method">
<dt id="src.models.regression.LinearRegression.explain">
<code class="sig-name descname">explain</code><span class="sig-paren">(</span><em class="sig-param">x: Optional[src.models.data.TrainData] = None</em>, <em class="sig-param">save_shap_values: bool = True</em><span class="sig-paren">)</span> &#x2192; numpy.ndarray<a class="headerlink" href="#src.models.regression.LinearRegression.explain" title="Permalink to this definition">¶</a></dt>
<dd><p>Explain the predictions of the trained model on the input data x</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><p><strong>x</strong> – Any input array / tensor</p>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p>A shap value for each of the input values. The sum of the shap
values is equal to the prediction of the model for x</p>
</dd>
</dl>
</dd></dl>

<dl class="method">
<dt id="src.models.regression.LinearRegression.save_model">
<code class="sig-name descname">save_model</code><span class="sig-paren">(</span><span class="sig-paren">)</span> &#x2192; None<a class="headerlink" href="#src.models.regression.LinearRegression.save_model" title="Permalink to this definition">¶</a></dt>
<dd><p>Saves a pickle object of the model, which can be loaded using
<code class="docutils literal notranslate"><span class="pre">src.models.load_model</span></code>.</p>
</dd></dl>

<dl class="method">
<dt id="src.models.regression.LinearRegression.train">
<code class="sig-name descname">train</code><span class="sig-paren">(</span><em class="sig-param">num_epochs: int = 1</em>, <em class="sig-param">early_stopping: Optional[int] = None</em>, <em class="sig-param">batch_size: int = 256</em>, <em class="sig-param">val_split: float = 0.1</em>, <em class="sig-param">initial_learning_rate: float = 1e-15</em><span class="sig-paren">)</span> &#x2192; None<a class="headerlink" href="#src.models.regression.LinearRegression.train" title="Permalink to this definition">¶</a></dt>
<dd><p>Train the linear regression model.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>num_epochs</strong> – The number of epochs to train the model for. If
<code class="docutils literal notranslate"><span class="pre">early_stopping</span></code> is not None, then this is the <strong>maximum</strong> number of
epochs for which the model will be trained. Default = <code class="docutils literal notranslate"><span class="pre">1</span></code>.</p></li>
<li><p><strong>early_stopping</strong> – If not <code class="docutils literal notranslate"><span class="pre">None</span></code>, the number of epochs to wait without
improvement before stopping model training and reverting to the best model.
Default = <code class="docutils literal notranslate"><span class="pre">None</span></code>.</p></li>
<li><p><strong>batch_size</strong> – The batch size to use when training the model. Default = <code class="docutils literal notranslate"><span class="pre">256</span></code>.</p></li>
<li><p><strong>val_split</strong> – The ratio of data to use in the validation set. Default = <code class="docutils literal notranslate"><span class="pre">0.1</span></code>.</p></li>
<li><p><strong>initial_learning_rate</strong> – The initial learning rate to use. Default = <code class="docutils literal notranslate"><span class="pre">1e-15</span></code>.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

</dd></dl>

</div>
<div class="section" id="neural-networks">
<h2>Neural Networks<a class="headerlink" href="#neural-networks" title="Permalink to this headline">¶</a></h2>
<p>A number of neural networks are implemented.
All are trained using <a class="reference external" href="https://pytorch.org/docs/stable/nn.html?highlight=smooth%20l1%20loss#torch.nn.SmoothL1Loss">Smooth L1 Loss</a>,
with optional early stopping.</p>
<p>All neural network classes extend the following base class:</p>
<dl class="class">
<dt id="src.models.neural_networks.base.NNBase">
<em class="property">class </em><code class="sig-prename descclassname">src.models.neural_networks.base.</code><code class="sig-name descname">NNBase</code><span class="sig-paren">(</span><em class="sig-param">data_folder: pathlib.Path = PosixPath('data')</em>, <em class="sig-param">batch_size: int = 1</em>, <em class="sig-param">experiment: str = 'one_month_forecast'</em>, <em class="sig-param">pred_months: Optional[List[int]] = None</em>, <em class="sig-param">include_pred_month: bool = True</em>, <em class="sig-param">include_latlons: bool = False</em>, <em class="sig-param">include_monthly_aggs: bool = True</em>, <em class="sig-param">include_yearly_aggs: bool = True</em>, <em class="sig-param">surrounding_pixels: Optional[int] = None</em>, <em class="sig-param">ignore_vars: Optional[List[str]] = None</em>, <em class="sig-param">static: Optional[str] = 'features'</em>, <em class="sig-param">device: str = 'cuda:0'</em>, <em class="sig-param">predict_delta: bool = False</em>, <em class="sig-param">spatial_mask: Union[xarray.core.dataarray.DataArray</em>, <em class="sig-param">pathlib.Path] = None</em>, <em class="sig-param">include_prev_y: bool = True</em>, <em class="sig-param">normalize_y: bool = True</em><span class="sig-paren">)</span><a class="headerlink" href="#src.models.neural_networks.base.NNBase" title="Permalink to this definition">¶</a></dt>
<dd><p>The base for all neural network models, written in Pytorch. It extends
the <code class="docutils literal notranslate"><span class="pre">ModelBase</span></code> class, and implements the <code class="docutils literal notranslate"><span class="pre">train</span></code>, <code class="docutils literal notranslate"><span class="pre">predict</span></code> and <code class="docutils literal notranslate"><span class="pre">explain</span></code>
functions, which are shared across all neural networks.</p>
<p>The arguments to the constructor are the same as for the <code class="docutils literal notranslate"><span class="pre">ModelBase</span></code> class.</p>
<dl class="method">
<dt id="src.models.neural_networks.base.NNBase.explain">
<code class="sig-name descname">explain</code><span class="sig-paren">(</span><em class="sig-param">x: Optional[src.models.data.TrainData] = None</em>, <em class="sig-param">var_names: Optional[List[str]] = None</em>, <em class="sig-param">save_explanations: bool = True</em>, <em class="sig-param">background_size: int = 100</em>, <em class="sig-param">start_idx: int = 0</em>, <em class="sig-param">num_inputs: int = 10</em>, <em class="sig-param">method: str = 'shap'</em><span class="sig-paren">)</span> &#x2192; src.models.data.TrainData<a class="headerlink" href="#src.models.neural_networks.base.NNBase.explain" title="Permalink to this definition">¶</a></dt>
<dd><p>Expain the outputs of a trained model.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>x</strong> – The values to explain. If None, samples are randomly drawn from
the test data</p></li>
<li><p><strong>var_names</strong> – The variable names of the historical inputs. If x is None, this
will be calculated. Only necessary if the arrays are going to be saved</p></li>
<li><p><strong>save_explanations</strong> – Whether or not to save the shap values</p></li>
<li><p><strong>background_size</strong> – the size of the background to use</p></li>
<li><p><strong>start_idx</strong> – The index to use to calculate the shap values. Shap values will be
calculated for <code class="docutils literal notranslate"><span class="pre">x[start_idx:</span> <span class="pre">start_idx</span> <span class="pre">+</span> <span class="pre">num_inputs]</span></code></p></li>
<li><p><strong>num_inputs</strong> – The number of datapoints to calculate shap values for</p></li>
<li><p><strong>method</strong> – One of <code class="docutils literal notranslate"><span class="pre">{&quot;shap&quot;,</span> <span class="pre">&quot;morris&quot;}</span></code>. The method to use to calculate the
explanations.</p></li>
</ul>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p>A dictionary of shap values for each of the model’s input arrays</p>
</dd>
</dl>
</dd></dl>

<dl class="method">
<dt id="src.models.neural_networks.base.NNBase.train">
<code class="sig-name descname">train</code><span class="sig-paren">(</span><em class="sig-param">num_epochs: int = 1</em>, <em class="sig-param">early_stopping: Optional[int] = None</em>, <em class="sig-param">batch_size: int = 256</em>, <em class="sig-param">learning_rate: float = 0.001</em>, <em class="sig-param">val_split: float = 0.1</em><span class="sig-paren">)</span> &#x2192; None<a class="headerlink" href="#src.models.neural_networks.base.NNBase.train" title="Permalink to this definition">¶</a></dt>
<dd><p>Trains a neural network.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>num_epochs</strong> – The maximum number of epochs to train the model for.</p></li>
<li><p><strong>early_stopping</strong> – If an int is passed, early stopping will be used with this
value as the patience. If None, the model will train for <code class="docutils literal notranslate"><span class="pre">num_epochs</span></code>.</p></li>
<li><p><strong>batch_size</strong> – The number of instances to put in each batch.</p></li>
<li><p><strong>learning_rate</strong> – The learning rate to use.</p></li>
<li><p><strong>val_split</strong> – The ratio of training data to use as validation, for early stopping.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

</dd></dl>

<div class="section" id="lstm">
<h3>LSTM<a class="headerlink" href="#lstm" title="Permalink to this headline">¶</a></h3>
<dl class="class">
<dt id="src.models.neural_networks.rnn.RecurrentNetwork">
<em class="property">class </em><code class="sig-prename descclassname">src.models.neural_networks.rnn.</code><code class="sig-name descname">RecurrentNetwork</code><span class="sig-paren">(</span><em class="sig-param">hidden_size: int</em>, <em class="sig-param">dense_features: Optional[List[int]] = None</em>, <em class="sig-param">rnn_dropout: float = 0.25</em>, <em class="sig-param">data_folder: pathlib.Path = PosixPath('data')</em>, <em class="sig-param">batch_size: int = 1</em>, <em class="sig-param">experiment: str = 'one_month_forecast'</em>, <em class="sig-param">pred_months: Optional[List[int]] = None</em>, <em class="sig-param">include_pred_month: bool = True</em>, <em class="sig-param">include_latlons: bool = False</em>, <em class="sig-param">include_monthly_aggs: bool = True</em>, <em class="sig-param">include_yearly_aggs: bool = True</em>, <em class="sig-param">surrounding_pixels: Optional[int] = None</em>, <em class="sig-param">ignore_vars: Optional[List[str]] = None</em>, <em class="sig-param">static: Optional[str] = 'features'</em>, <em class="sig-param">device: str = 'cuda:0'</em>, <em class="sig-param">predict_delta: bool = False</em>, <em class="sig-param">spatial_mask: Union[xarray.core.dataarray.DataArray</em>, <em class="sig-param">pathlib.Path] = None</em>, <em class="sig-param">include_prev_y: bool = True</em>, <em class="sig-param">normalize_y: bool = True</em><span class="sig-paren">)</span><a class="headerlink" href="#src.models.neural_networks.rnn.RecurrentNetwork" title="Permalink to this definition">¶</a></dt>
<dd><p>A single layer long short-term memory (LSTM) layer, followed by linear layers.</p>
<p>See <a class="reference external" href="http://colah.github.io/posts/2015-08-Understanding-LSTMs/">this blog post</a> for more
information about recurrent networks and LSTMS.</p>
<p>The LSTM receives the static data appended to every time step of the dynamic data. In addition to
the arguments to <code class="docutils literal notranslate"><span class="pre">ModelBase</span></code>, the LSTM has the following arguments passed to the constructor:</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>hidden_size</strong> – The number of features in the hidden state</p></li>
<li><p><strong>dense_features</strong> – A list describing the linear layers after the LSTM layer. There will be
a layer per element in the list, with output size equal to the value of the element. If <code class="docutils literal notranslate"><span class="pre">None</span></code>,
a single linear layer is used, with an output size of 1 (the prediction).</p></li>
<li><p><strong>rnn_dropout</strong> – Dropout to use <strong>between</strong> timesteps. Note that this is different from PyTorch’s
default LSTM layer, which adds dropout between layers, not timesteps.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

</div>
<div class="section" id="ea-lstm">
<h3>EA-LSTM<a class="headerlink" href="#ea-lstm" title="Permalink to this headline">¶</a></h3>
<dl class="class">
<dt id="src.models.neural_networks.ealstm.EARecurrentNetwork">
<em class="property">class </em><code class="sig-prename descclassname">src.models.neural_networks.ealstm.</code><code class="sig-name descname">EARecurrentNetwork</code><span class="sig-paren">(</span><em class="sig-param">hidden_size: int</em>, <em class="sig-param">dense_features: Optional[List[int]] = None</em>, <em class="sig-param">rnn_dropout: float = 0.25</em>, <em class="sig-param">data_folder: pathlib.Path = PosixPath('data')</em>, <em class="sig-param">batch_size: int = 1</em>, <em class="sig-param">experiment: str = 'one_month_forecast'</em>, <em class="sig-param">pred_months: Optional[List[int]] = None</em>, <em class="sig-param">include_latlons: bool = False</em>, <em class="sig-param">include_pred_month: bool = True</em>, <em class="sig-param">include_monthly_aggs: bool = True</em>, <em class="sig-param">include_yearly_aggs: bool = True</em>, <em class="sig-param">surrounding_pixels: Optional[int] = None</em>, <em class="sig-param">ignore_vars: Optional[List[str]] = None</em>, <em class="sig-param">static: Optional[str] = 'features'</em>, <em class="sig-param">static_embedding_size: Optional[int] = None</em>, <em class="sig-param">device: str = 'cuda:0'</em>, <em class="sig-param">predict_delta: bool = False</em>, <em class="sig-param">spatial_mask: Union[xarray.core.dataarray.DataArray</em>, <em class="sig-param">pathlib.Path] = None</em>, <em class="sig-param">include_prev_y: bool = True</em>, <em class="sig-param">normalize_y: bool = True</em><span class="sig-paren">)</span><a class="headerlink" href="#src.models.neural_networks.ealstm.EARecurrentNetwork" title="Permalink to this definition">¶</a></dt>
<dd><p>An Entity Aware - LSTM, described in
<a class="reference external" href="https://www.hydrol-earth-syst-sci.net/23/5089/2019/hess-23-5089-2019.html">Towards learning universal, regional, and local hydrological behaviors via machine learning applied to large-sample datasets</a></p>
<p>In an EA-LSTM, the dynamic features are conditioned on the static features.</p>
<p>In addition to the arguments to <code class="docutils literal notranslate"><span class="pre">ModelBase</span></code>, the EA-LSTM has the following arguments
passed to the constructor:</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>hidden_size</strong> – The number of features in the hidden state</p></li>
<li><p><strong>dense_features</strong> – A list describing the linear layers after the LSTM layer. There will be
a layer per element in the list, with output size equal to the value of the element. If <code class="docutils literal notranslate"><span class="pre">None</span></code>,
a single linear layer is used, with an output size of 1 (the prediction).</p></li>
<li><p><strong>rnn_dropout</strong> – Dropout to use <strong>between</strong> timesteps. Note that this is different from PyTorch’s
default LSTM layer, which adds dropout between layers, not timesteps.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

</div>
<div class="section" id="linear-network">
<h3>Linear Network<a class="headerlink" href="#linear-network" title="Permalink to this headline">¶</a></h3>
<dl class="class">
<dt id="src.models.neural_networks.linear_network.LinearNetwork">
<em class="property">class </em><code class="sig-prename descclassname">src.models.neural_networks.linear_network.</code><code class="sig-name descname">LinearNetwork</code><span class="sig-paren">(</span><em class="sig-param">layer_sizes: Union[int, List[int]], dropout: float = 0.25, data_folder: pathlib.Path = PosixPath('data'), batch_size: int = 1, experiment: str = 'one_month_forecast', pred_months: Optional[List[int]] = None, include_pred_month: bool = True, include_latlons: bool = False, include_monthly_aggs: bool = True, include_yearly_aggs: bool = True, surrounding_pixels: Optional[int] = None, ignore_vars: Optional[List[str]] = None, static: Optional[str] = 'features', device: str = 'cuda:0', predict_delta: bool = False, spatial_mask: Union[xarray.core.dataarray.DataArray, pathlib.Path] = None, include_prev_y: bool = True, normalize_y: bool = True</em><span class="sig-paren">)</span><a class="headerlink" href="#src.models.neural_networks.linear_network.LinearNetwork" title="Permalink to this definition">¶</a></dt>
<dd><p>A linear neural network.</p>
<p>In addition to <code class="docutils literal notranslate"><span class="pre">ModelBase</span></code>, the linear network has the following arguments
passed to the constructor:</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>layer_sizes</strong> – A list describing the linear layers after the LSTM layer. There will be
a layer per element in the list, with output size equal to the value of the element. If an
<code class="docutils literal notranslate"><span class="pre">int</span></code> is passed, the model will only have one hidden layer.</p></li>
<li><p><strong>dropout</strong> – The dropout value to use between layers.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><h3><a href="index.html">ml_clim</a></h3>
<p class="caption"><span class="caption-text">Getting started:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="develop.html">Developing</a></li>
</ul>
<p class="caption"><span class="caption-text">Pipeline:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="data.html">The data directory</a></li>
<li class="toctree-l1"><a class="reference internal" href="exporters.html">Exporters</a></li>
<li class="toctree-l1"><a class="reference internal" href="preprocessor.html">Preprocessor</a></li>
<li class="toctree-l1"><a class="reference internal" href="datasets.html">Datasets</a><ul>
<li class="toctree-l2"><a class="reference internal" href="datasets.html#climate-data-store">Climate Data Store</a><ul>
<li class="toctree-l3"><a class="reference internal" href="datasets.html#era5-era5-land-monthly-averaged-data">ERA5 / ERA5 Land monthly averaged data</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="datasets.html#chirps-rainfall-estimates">CHIRPS Rainfall Estimates</a></li>
<li class="toctree-l2"><a class="reference internal" href="datasets.html#srtm-digital-elevation-data">SRTM Digital Elevation Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="datasets.html#global-land-evaporation-amsterdam-model">Global Land Evaporation Amsterdam Model</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="engineer.html">Engineer</a></li>
<li class="toctree-l1"><a class="reference internal" href="dataloader.html">Dataloader</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Models</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#loading-models">Loading models</a></li>
<li class="toctree-l2"><a class="reference internal" href="#persistence">Persistence</a></li>
<li class="toctree-l2"><a class="reference internal" href="#linear-regression">Linear Regression</a></li>
<li class="toctree-l2"><a class="reference internal" href="#neural-networks">Neural Networks</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#lstm">LSTM</a></li>
<li class="toctree-l3"><a class="reference internal" href="#ea-lstm">EA-LSTM</a></li>
<li class="toctree-l3"><a class="reference internal" href="#linear-network">Linear Network</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/models.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="dataloader.html" title="Dataloader"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">ml_clim  documentation</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2020, Thomas Lees, Gabriel Tseng.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 2.4.3.
    </div>
  </body>
</html>